{{ define "homeserver.yaml.template" }}
  {{ $server_name := .Values.appConfig.homeserver.server_name }}
  {{ with .Values.persistence }}

    {{/* define signing_key_path depending on whether existing key is provided in values.yaml */}}
    {{ $signing_key_path := empty $.Values.appConfig.signingKey | ternary .data.mountPath .config.mountPath }}

    # This is the default configuration file generated by running the official container matrixdotorg/synapse in generate mode as of v1.77.0

    ######################################
    # Configuration file for Synapse.
    #
    # This is a YAML file: see [1] for a quick introduction. Note in particular
    # that *indentation is important*: all the elements of a list or dictionary
    # should have the same indentation.
    #
    # [1] https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html
    #
    # For more information on how to configure Synapse, including a complete accounting of
    # each option, go to docs/usage/configuration/config_documentation.md or
    # https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html
    server_name: "example.com"
    public_baseurl: 'https://matrix.{{ $server_name }}'
    pid_file: "{{ .data.mountPath }}/homeserver.pid"
    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        resources:
          - names: [client, federation]
            compress: false
    database:
      name: sqlite3
      args:
        database: "{{ .db.mountPath }}/homeserver.db"
    log_config: "{{ .config.mountPath }}/{{ $server_name }}.log.config"
    media_store_path: "{{ .media.mountPath }}"
    #registration_shared_secret: "You need to set your own secrets"
    report_stats: false
    #macaroon_secret_key:        "You need to set your own secrets"
    #form_secret:                "You need to set your own secrets"
    signing_key_path: "{{ $signing_key_path }}/{{ $server_name }}.signing.key"
    trusted_key_servers:
      - server_name: "matrix.org"

    ######################################

    # Below are additional defaults that are sensible to keep
    # url previews
    url_preview_enabled: true
    url_preview_ip_range_blacklist:
      - '127.0.0.0/8'
      - '10.0.0.0/8'
      - '172.16.0.0/12'
      - '192.168.0.0/16'
      - '100.64.0.0/10'
      - '169.254.0.0/16'
      - '192.0.0.0/24'
      - '192.88.99.0/24'
      - '198.18.0.0/15'
      - '192.0.2.0/24'
      - '198.51.100.0/24'
      - '203.0.113.0/24'
      - '224.0.0.0/4'
      - '::1/128'
      - 'fe80::/10'
      - 'fc00::/7'
      - '2001:db8::/32'
      - 'ff00::/8'
      - 'fec0::/10'

  {{ end }}
{{ end }}

{{/* Merge the override values and the template defaults */}}
{{- define "homeserver.yaml" }}
  {{- $overrideValues := deepCopy (default (fromYaml "{}") .Values.appConfig.homeserver) }}
  {{- $templateValues := fromYaml (include "homeserver.yaml.template" .) }}
  {{- $mergedValues := mustMergeOverwrite $templateValues $overrideValues }}
  {{- tpl (toYaml $mergedValues) . }}

# vim:ft=yaml
{{- end }}
